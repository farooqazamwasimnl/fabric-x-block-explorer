syntax = "proto3";

package explorer;

option go_package = "github.com/LF-Decentralized-Trust-labs/fabric-x-block-explorer/pkg/api/proto";

// BlockExplorer service provides APIs to query blockchain data
service BlockExplorer {
  // GetBlockHeight returns the current block height
  rpc GetBlockHeight(BlockHeightRequest) returns (BlockHeightResponse);
  
  // GetBlock returns block details by block number
  rpc GetBlock(GetBlockRequest) returns (BlockResponse);
  
  // GetTransaction returns transaction details by transaction ID
  rpc GetTransaction(GetTransactionRequest) returns (TransactionResponse);

  // GetNamespacePolicies returns policy versions for a namespace
  rpc GetNamespacePolicies(GetNamespacePoliciesRequest) returns (NamespacePoliciesResponse);
  
  // HealthCheck returns service health status
  rpc HealthCheck(HealthRequest) returns (HealthResponse);
}

// BlockHeightRequest - empty request
message BlockHeightRequest {}

// BlockHeightResponse contains the current block height
message BlockHeightResponse {
  int64 height = 1;
}

// GetBlockRequest to fetch a block by number
message GetBlockRequest {
  int64 block_num = 1;
  int32 limit_tx = 2;       // max transactions to return
  int32 offset_tx = 3;      // transaction offset
  int32 limit_writes = 4;   // max writes per transaction
  int32 offset_writes = 5;  // write offset
}

// BlockResponse contains block details
message BlockResponse {
  int64 block_num = 1;
  int32 tx_count = 2;
  string previous_hash = 3;
  string data_hash = 4;
  repeated TransactionWithWrites transactions = 5;
}

// TransactionWithWrites contains transaction and its read/write sets
message TransactionWithWrites {
  int64 id = 1;
  int64 tx_num = 2;
  string tx_id = 3;
  int64 validation_code = 4;
  repeated ReadRecord reads = 5;
  repeated WriteRecord writes = 6;
  repeated EndorsementRecord endorsements = 7;
}

// ReadRecord contains a single read record
message ReadRecord {
  int64 id = 1;
  string ns_id = 2;
  string key = 3;
  optional int64 version = 4;
  bool is_read_write = 5;
}

// WriteRecord contains a single write record
message WriteRecord {
  int64 id = 1;
  string ns_id = 2;
  string key = 3;
  string value = 4;
  bool is_blind_write = 5;
  optional int64 read_version = 6;
}

// EndorsementRecord contains a single endorsement record
message EndorsementRecord {
  int64 id = 1;
  string ns_id = 2;
  string endorsement = 3;
  optional string msp_id = 4;
  optional string identity = 5;
}

// GetTransactionRequest to fetch transaction by ID
message GetTransactionRequest {
  string tx_id = 1; // hex encoded transaction ID
}

// GetNamespacePoliciesRequest to fetch policies by namespace
message GetNamespacePoliciesRequest {
  string namespace = 1;
  bool latest = 2;
}

// NamespacePoliciesResponse contains policy versions for a namespace
message NamespacePoliciesResponse {
  repeated NamespacePolicy policies = 1;
}

// NamespacePolicy contains a single policy version
message NamespacePolicy {
  int64 id = 1;
  string namespace = 2;
  int64 version = 3;
  string policy = 4;
}

// TransactionResponse contains transaction with block context
message TransactionResponse {
  TransactionWithWrites transaction = 1;
  BlockHeader block = 2;
}

// BlockHeader contains basic block information
message BlockHeader {
  int64 block_num = 1;
  int32 tx_count = 2;
  string previous_hash = 3;
  string data_hash = 4;
}

// HealthRequest - empty request
message HealthRequest {}

// HealthResponse contains service health status
message HealthResponse {
  string status = 1;
  string details = 2;
}
