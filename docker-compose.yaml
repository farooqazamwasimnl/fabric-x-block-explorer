version: "3.8"

services:
  postgres:
    image: postgres:14-alpine
    container_name: explorer-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: explorer
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./pkg/db/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  explorer:
    build:
      context: .
      dockerfile: Dockerfile
    image: fabric-x-explorer:latest
    container_name: fabric-x-explorer
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      # Sidecar settings
      EXPLORER_SIDECAR_HOST: "host.docker.internal"
      EXPLORER_SIDECAR_PORT: "4001"
      EXPLORER_SIDECAR_CHANNEL: "mychannel"
      EXPLORER_SIDECAR_START_BLOCK: "0"
      # EXPLORER_SIDECAR_END_BLOCK: "0"   # optional; omit or set to a large value for "no upper limit"

      # Database settings
      EXPLORER_DATABASE_HOST: "postgres"
      EXPLORER_DATABASE_PORT: "5432"
      EXPLORER_DATABASE_USER: "postgres"
      EXPLORER_DATABASE_PASSWORD: "postgres"
      EXPLORER_DATABASE_NAME: "explorer"
      EXPLORER_DATABASE_SSLMODE: "disable"

      # Server settings
      EXPLORER_SERVER_HTTP_ADDR: ":8080"

      # Logging
      EXPLORER_LOGGING_LEVEL: "info"
      EXPLORER_LOGGING_FORMAT: "json"

      # Pipeline tuning
      EXPLORER_PIPELINE_RAW_CHANNEL_SIZE: "200"
      EXPLORER_PIPELINE_PROCESS_CHANNEL_SIZE: "200"
      EXPLORER_PIPELINE_PROCESS_WORKERS: "4"
      EXPLORER_PIPELINE_WRITE_WORKERS: "2"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  postgres_data:
    driver: local
